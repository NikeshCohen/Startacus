sh .husky/check-branch.sh

# track if changes are stashed
STASHED=0

# stash unstaged and untracked changes, while keeping staged changes
if ! git diff --quiet || ! git diff --cached --quiet; then
  git stash --keep-index -u
  printf "\nğŸ”„ Stashing unstaged changes for clean commit...\n"
  STASHED=1
fi

# run type check
printf "\nğŸ” Running type check...\n"
if ! npm run typecheck; then
  printf "\nâŒ Type errors detected!\n"
  printf "ğŸ”§ Please fix the type errors before committing.\n"
  printf "ğŸ’¡ You can run 'npm run typecheck' to see the issues.\n"
  
  # apply stash only if it was stashed during this session
  if [ $STASHED -eq 1 ]; then
    git stash apply
    printf "\nğŸ”„ Unstashed changes have been restored.\n"
  fi
  
  exit 1
fi
printf "âœ… Type check passed!\n"

# check if changes were made
if ! git diff --quiet --exit-code; then
  printf "\nâ— Code formatting issues detected and fixed automatically.\n"
  printf "ğŸ“ Please review the changes and stage them with 'git add .'\n"
  printf "ğŸ” Then try committing again.\n"
  # cancel commit so user can review
  exit 1
fi

# apply stash only if it was stashed during this session
if [ $STASHED -eq 1 ]; then
  git stash apply
  printf "\nâœ… Commit checks passed! Unstashed changes have been restored.\n\n"
fi